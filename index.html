<!DOCTYPE html>
<html>
<head>
  <meta charset="UTF-8">
  <title>JSON Query Result by Params</title>
  <style>
    pre { font-family: ui-monospace, monospace; background: #f9f9f9; color: #222; border-radius: 6px; padding: 1em; }
    .error { color: #c00; font-family: ui-monospace, monospace; }
  </style>
</head>
<body>
<script>
// --- Parse parameters in order of appearance ---
function getOrderedParams() {
  const urlParams = [];
  const q = window.location.search.substring(1);
  q.split('&').forEach(pair => {
    if (!pair) return;
    const [k, v] = pair.split('=').map(decodeURIComponent);
    if (k) urlParams.push([k, v === undefined ? true : v]);
  });
  return urlParams;
}

// --- Query JSON by sequential params ---
function queryByParamChain(data, orderedParams) {
  // Find 'file' param and validate
  const fileParam = orderedParams.find(([k]) => k === 'file');
  if (!fileParam) throw new Error("Missing 'file' parameter");
  // Remove 'file' for traversal
  const steps = orderedParams.filter(([k]) => k !== 'file');

  let cursor = data;
  for (const [key, val] of steps) {
    if (Array.isArray(cursor)) {
      // If param is a number: index into array
      if (/^\d+$/.test(val === true ? key : val)) {
        const idx = Number(val === true ? key : val);
        cursor = cursor[idx];
      }
      // If object filter: e.g. id=4 or username=alice
      else if (val !== true) {
        cursor = cursor.find(item => item && String(item[key]) === val);
      } else {
        // error? Can't filter array by bare 'address'
        return undefined;
      }
    } else if (cursor && typeof cursor === 'object') {
      // Go down object property
      if (key in cursor) {
        cursor = cursor[key];
      } else {
        return undefined;
      }
    } else {
      return undefined;
    }
    if (cursor === undefined) return undefined;
  }
  return cursor;
}

async function main() {
  const orderedParams = getOrderedParams();
  const fileParam = orderedParams.find(([k]) => k === 'file');
  if (!fileParam) {
    document.body.innerHTML = '<div class="error">Missing <code>file</code> parameter in URL.</div>';
    return;
  }
  const fileValue = fileParam[1];
  const jsonUrl = "./data/" + encodeURIComponent(fileValue) + ".json";
  let jsonData;
  try {
    const res = await fetch(jsonUrl);
    if (!res.ok) throw new Error("404");
    jsonData = await res.json();
  } catch {
    document.body.innerHTML = `<div class="error">File not found or fetch failed. Attempted URL: <code>${jsonUrl}</code></div>`;
    return;
  }
  let result;
  try {
    result = queryByParamChain(jsonData, orderedParams);
  } catch (e) {
    document.body.innerHTML = `<div class="error">Parse error: <code>${e.message}</code></div>`;
    return;
  }
  if (result === undefined) {
    const q = orderedParams.filter(([k]) => k !== 'file').map(([k,v]) => v === true ? k : `${k}=${v}`).join("â†’");
    document.body.innerHTML = `<div class="error">Segment not found for query: <code>${q}</code></div>`;
  } else {
    document.body.innerHTML = `<pre>${escapeHtml(JSON.stringify(result, null, 2))}</pre>`;
  }
}

function escapeHtml(str) {
  return str.replace(/[<>&]/g, s => ({"<":"&lt;","&": "&amp;",">":"&gt;"}[s]));
}

main();
</script>
</body>
</html>
