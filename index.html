<!DOCTYPE html>
<html>
<head>
  <meta charset="UTF-8">
  <title>JSON Query Result</title>
  <style>
    pre { font-family: ui-monospace, monospace; background: #f9f9f9; color: #222; border-radius: 6px; padding: 1em; white-space: pre-wrap;}
    .error { color: #c00; font-family: ui-monospace, monospace; }
  </style>
</head>
<body>
<script>
// ---- Get params from URL ----
function getParams() {
  const params = {};
  window.location.search.replace(/[?&]+([^=&]+)=([^&]*)/gi, (_, k, v) => params[k] = decodeURIComponent(v));
  return params;
}

// ---- Flexible Segment Getter: supports "id=2" as filter ----
function getFlexibleSegment(obj, path) {
  if (!path) return obj;
  const parts = path.split('.');
  let cursor = obj;
  for (let part of parts) {
    const filterMatch = part.match(/^(\w+)\=(.+)$/);
    if (Array.isArray(cursor) && filterMatch) {
      // Filter array by key=value
      const key = filterMatch[1], val = filterMatch[2];
      cursor = cursor.find(item => item && String(item[key]) === val);
    } else if (Array.isArray(cursor) && /^\d+$/.test(part)) {
      // Numeric index in array
      cursor = cursor[Number(part)];
    } else if (cursor && Object.prototype.hasOwnProperty.call(cursor, part)) {
      cursor = cursor[part];
    } else {
      return undefined;
    }
    if (cursor === undefined) return undefined;
  }
  return cursor;
}

async function main() {
  const params = getParams();
  // Basic validation
  if (!params.file) {
    document.body.innerHTML = '<div class="error">Missing <code>file</code> parameter in URL.</div>';
    return;
  }
  const jsonUrl = "./data/" + encodeURIComponent(params.file) + ".json";
  let jsonData;
  try {
    const res = await fetch(jsonUrl);
    if (!res.ok) throw new Error("404");
    jsonData = await res.json();
  } catch {
    document.body.innerHTML = `<div class="error">File not found or fetch failed. Attempted URL: <code>${jsonUrl}</code></div>`;
    return;
  }
  let result;
  try {
    result = getFlexibleSegment(jsonData, params.path);
  } catch (e) {
    document.body.innerHTML = `<div class="error">Invalid path or parse error: <code>${e.message}</code></div>`;
    return;
  }
  if (result === undefined) {
    document.body.innerHTML = `<div class="error">Segment not found for path: <code>${params.path || ""}</code></div>`;
  } else {
    // Overwrite the page with only this JSON:
    document.body.innerHTML = `<pre>${escapeHtml(JSON.stringify(result, null, 2))}</pre>`;
    // Optionally force pretty printing in browser, and easy to parse in Java.
  }
}

function escapeHtml(str) {
  return str.replace(/[<>&]/g, function (s) {
    return {"<":"&lt;","&": "&amp;",">":"&gt;"}[s];
  });
}

main();
</script>
</body>
</html>
