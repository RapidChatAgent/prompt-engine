<!DOCTYPE html>
<html>
<head>
  <meta charset="UTF-8">
  <title>JSON Param Query Debugger</title>
  <style>
    pre { font-family: ui-monospace, monospace; background: #f9f9f9; color: #222; border-radius: 6px; padding: 1em; }
    .error { color: #c00; font-family: ui-monospace, monospace; padding: 1em; }
    .debug, .warn, .error-step {
      font-family: ui-monospace, monospace;
      font-size: 1em;
      margin-bottom: 0.4em;
      margin-top: 0.4em;
      border-radius: 6px;
      background: #fffbe5;
      color: #543c11;
      border: 1px solid #eee2b1;
    }
    .warn { background: #ffe4e0; color: #9b3939;border:1px solid #ffd2cb;}
    .error-step { background: #ffeaea; color: #891818; border:1px solid #ffc1c1;}
    .stephead {
      font-family: inherit;
      background: #f7f4e8;
      border: 0;
      color: #543c11;
      font-size: 1em;
      padding: 0.3em 0.8em 0.3em 0em;
      border-radius: 4px;
      cursor: pointer;
      outline: none;
      width:100%;
      text-align: left;
      margin-bottom: 0;
      margin-top: 0;
      display: flex;
      align-items: center;
    }
    .arrow {
      font-size:1.2em;
      margin-right:0.3em;
      transition: transform 0.1s;
      user-select:none;
    }
    .stepbody {
      display: none;
      padding: 0 1em 0.75em 1.5em;
    }
    .collapsible.open .stepbody {
      display: block;
    }
    .collapsible .arrow {
      transform: rotate(0deg);
    }
    .collapsible.open .arrow {
      transform: rotate(90deg);
    }
  </style>
</head>
<body>
<div id="log"></div>
<div id="output"></div>
<script>
// Unique id for collapse steps
let stepId = 0;

// Helper for HTML-escaping
function escapeHtml(str) {
  return str.replace(/[<>&]/g, s => ({"<":"&lt;","&": "&amp;",">":"&gt;"}[s]));
}

// Helper: output log (collapsible per step) and to console
function stepLog(msg, data, kind="debug", logsArr) {
  stepId++;
  const currentId = "step_collapse_" + stepId;
  const classKind = kind==="warn" ? "warn" : kind==="error"||kind==="error-step" ? "error-step" : "debug";
  const arrow = `<span class="arrow">&#9654;</span>`; // triangle

  let shortMsg = msg.split("<br>")[0];
  let extraMsg = msg.split("<br>").slice(1).join("<br>");
  let codeHtml = data !== undefined ? `<pre>${escapeHtml(JSON.stringify(data,null,2))}</pre>` : "";

  let bodyHtml = "";
  if (extraMsg || codeHtml) bodyHtml =
    `<div class="stepbody">${extraMsg ? `<div>${extraMsg}</div>` : ""}${codeHtml}</div>`;

  const block = `<div class="collapsible ${classKind}" id="${currentId}">
    <button class="stephead" type="button" onclick="toggleStep('${currentId}')">${arrow}${shortMsg}</button>
    ${bodyHtml}
  </div>`;

  if (logsArr) logsArr.push(block);

  // always log to the browser console
  if(kind==="error"||kind==="error-step") console.error(shortMsg, data);
  else if(kind==="warn") console.warn(shortMsg, data);
  else if(kind==="result") console.info(shortMsg, data);
  else console.log(shortMsg, data);
}

window.toggleStep = function(id) {
  const el = document.getElementById(id);
  if (!el) return;
  el.classList.toggle('open');
};

function getOrderedParams() {
  const urlParams = [];
  const q = window.location.search.substring(1);
  q.split('&').forEach(pair => {
    if (!pair) return;
    const [k, v] = pair.split('=').map(decodeURIComponent);
    if (k) urlParams.push([k, v === undefined ? true : v]);
  });
  return urlParams;
}

function queryByParamChain(data, orderedParams, logsArr) {
  stepLog(`[Step 0][ROOT] Loaded data:`, data, "debug", logsArr);

  const fileParam = orderedParams.find(([k]) => k === 'file');
  if (!fileParam) throw new Error("Missing 'file' parameter");
  const steps = orderedParams.filter(([k]) => k !== 'file');

  let cursor = data;
  let pathDisplay = [];

  steps.forEach(([key, val], stepIdx) => {
    let msg = `[Step ${stepIdx + 1}] Path: ${pathDisplay.join('.') || '[root]'} | Param: [${key}${val===true?'':('='+val)}]<br>Current value/type:`;
    stepLog(msg, cursor, "debug", logsArr);

    if (Array.isArray(cursor)) {
      if (/^\d+$/.test(val === true ? key : val)) {
        const idx = Number(val === true ? key : val);
        stepLog(`-- Array index [${idx}]`, cursor[idx], "debug", logsArr);
        cursor = cursor[idx];
        pathDisplay.push(String(idx));
      }
      else if (val !== true) {
        stepLog(`-- Array filter: "${key}==${val}"`, undefined, "debug", logsArr);
        const filtered = cursor.find(item => item && String(item[key]) === val);
        if (!filtered) stepLog(`[Warning] Array filter "${key}=${val}" not found!`, cursor, "warn", logsArr);
        cursor = filtered;
        pathDisplay.push(`${key}=${val}`);
      } else {
        stepLog(`-- [Error] Cannot use property "${key}" with no value on array!`, cursor, "error-step", logsArr);
        cursor = undefined;
      }
    } else if (cursor && typeof cursor === 'object') {
      if (key in cursor) {
        stepLog(`-- Object property "${key}"`, cursor[key], "debug", logsArr);
        cursor = cursor[key];
        pathDisplay.push(key);
      } else {
        stepLog(`-- [FAIL] Property "${key}" not found in object. Keys: ${Object.keys(cursor).join(", ")}`, cursor, "warn", logsArr);
        cursor = undefined;
      }
    } else {
      stepLog(`-- [FAIL] Cannot process param "${key}" on type: ${typeof cursor} (${String(cursor)})`, cursor, "error-step", logsArr);
      cursor = undefined;
    }
    stepLog(`[Step ${stepIdx + 1}] Result after applying param:`, cursor, "debug", logsArr);
  });
  stepLog(`==== END QUERY / FINAL VALUE ====`, cursor, cursor !== undefined ? "result" : "warn", logsArr);
  return cursor;
}

async function main() {
  document.getElementById("log").innerHTML = "";
  document.getElementById("output").innerHTML = "";
  stepId = 0;
  const orderedParams = getOrderedParams();
  const fileParam = orderedParams.find(([k]) => k === 'file');
  if (!fileParam) {
    document.getElementById("log").innerHTML = '<div class="error">Missing <code>file</code> parameter in URL.</div>';
    return;
  }
  const fileValue = fileParam[1];
  const jsonUrl = "./data/" + encodeURIComponent(fileValue) + ".json";
  let jsonData;
  try {
    const res = await fetch(jsonUrl);
    if (!res.ok) throw new Error("404");
    jsonData = await res.json();
    // Optionally, log to console: what file was loaded
    console.log(`[Loaded JSON] from "${jsonUrl}"`, jsonData);
  } catch {
    document.getElementById("log").innerHTML = `<div class="error">File not found or fetch failed. Attempted URL: <code>${jsonUrl}</code></div>`;
    return;
  }
  let logsArr = [];
  let result;
  try {
    result = queryByParamChain(jsonData, orderedParams, logsArr);
  } catch (e) {
    document.getElementById("log").innerHTML = `<div class="error">Parse error: <code>${e.message}</code></div>`;
    return;
  }
  if (result === undefined) {
    // On error, show debug logs, each step collapsible
    document.getElementById("log").innerHTML = logsArr.join("");
    const q = orderedParams.filter(([k]) => k !== 'file').map(([k,v]) => v === true ? k : `${k}=${v}`).join("&");
    document.getElementById("output").innerHTML = `<div class="error">Segment not found for query: <code>${q}</code></div>`;
  } else {
    document.getElementById("log").innerHTML = '';
    document.getElementById("output").innerHTML = `<pre>${escapeHtml(JSON.stringify(result, null, 2))}</pre>`;
  }
}
main();
</script>
</body>
</html>
